#!/bin/bash
# Start all services needed to test the full onboarding setup flow.
# Runs: captive portal + Python backend (mock) + Next.js dashboard

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_DIR"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

PIDS=()

cleanup() {
    echo ""
    echo -e "${YELLOW}Shutting down...${NC}"
    for pid in "${PIDS[@]}"; do
        kill "$pid" 2>/dev/null || true
    done
    kill $(jobs -p) 2>/dev/null || true
    exit 0
}

trap cleanup SIGINT SIGTERM

echo ""
echo -e "${BLUE}Nightwatch Setup Test${NC}"
echo "====================="
echo ""

# 1. Start Python backend with mock sensors
echo -e "${YELLOW}Starting Python backend (mock mode)...${NC}"
NIGHTWATCH_MOCK=1 python -m nightwatch &
PIDS+=($!)
echo -e "${GREEN}✓ Python backend started${NC}"

# 2. Start Next.js dashboard
echo -e "${YELLOW}Starting Next.js dashboard...${NC}"
cd dashboard-ui
if [ ! -d "node_modules" ]; then
    echo "  Installing dependencies..."
    npm install
fi
npm run dev &
PIDS+=($!)
cd "$PROJECT_DIR"
echo -e "${GREEN}✓ Dashboard started${NC}"

# 3. Start captive portal in dev mode
echo -e "${YELLOW}Starting captive portal (dev mode)...${NC}"
python -m nightwatch.setup.portal --dev &
PIDS+=($!)
echo -e "${GREEN}✓ Captive portal started${NC}"

# Wait for services to be ready
sleep 2

echo ""
echo "=============================================="
echo -e "${GREEN}Nightwatch Setup Test${NC}"
echo "=============================================="
echo ""
echo -e "  WiFi Setup:  ${BLUE}http://localhost:9532/setup${NC}  (start here)"
echo -e "  Dashboard:   ${BLUE}http://localhost:9530/setup${NC}  (redirects here after WiFi)"
echo -e "  Python API:  ${BLUE}http://localhost:9531${NC}"
echo ""
echo "Press Ctrl+C to stop all services"
echo ""

wait
