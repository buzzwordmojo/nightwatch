#!/bin/bash
# Start Nightwatch in development mode
# Runs: Python backend + Next.js dashboard + Convex (if using Docker)

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

cd "$PROJECT_DIR"

echo "ðŸŒ™ Starting Nightwatch Development Environment"
echo "=============================================="

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if running with mock sensors
MOCK_MODE=${MOCK:-false}

# Function to cleanup on exit
cleanup() {
    echo ""
    echo -e "${YELLOW}Shutting down...${NC}"
    kill $(jobs -p) 2>/dev/null || true
    exit 0
}

trap cleanup SIGINT SIGTERM

# Start Convex local (if Docker available)
if command -v docker &> /dev/null; then
    if ! docker ps | grep -q nightwatch-convex; then
        echo -e "${YELLOW}Starting Convex local backend...${NC}"
        docker compose up -d convex 2>/dev/null || echo "Convex container not started (may already be running or not configured)"
    else
        echo -e "${GREEN}âœ“ Convex already running${NC}"
    fi
else
    echo -e "${YELLOW}Docker not found - skipping Convex local${NC}"
    echo "  Dashboard will need NEXT_PUBLIC_CONVEX_URL configured"
fi

# Start Python backend
echo ""
echo -e "${YELLOW}Starting Python backend...${NC}"

if [ "$MOCK_MODE" = "true" ]; then
    echo "  (Running with mock sensors)"
    NIGHTWATCH_MOCK=1 python -m nightwatch &
else
    python -m nightwatch &
fi

PYTHON_PID=$!
echo -e "${GREEN}âœ“ Python backend started (PID: $PYTHON_PID)${NC}"

# Start Next.js dashboard
echo ""
echo -e "${YELLOW}Starting Next.js dashboard...${NC}"

cd dashboard-ui

if [ ! -d "node_modules" ]; then
    echo "  Installing dependencies..."
    npm install
fi

npm run dev &
NEXTJS_PID=$!
echo -e "${GREEN}âœ“ Dashboard started (PID: $NEXTJS_PID)${NC}"

cd "$PROJECT_DIR"

# Print status
echo ""
echo "=============================================="
echo -e "${GREEN}ðŸŒ™ Nightwatch is running!${NC}"
echo ""
echo "  Dashboard:  http://localhost:9530"
echo "  Python API: http://localhost:9531"
echo "  Convex:     http://localhost:3210 (if using Docker)"
echo ""
echo "Press Ctrl+C to stop all services"
echo ""

# Wait for processes
wait
