#!/bin/bash
#
# Nightwatch VM management helper
#
# Usage:
#   ./bin/vm start [--fast]     Start the Pi VM
#   ./bin/vm ssh                SSH into running VM
#   ./bin/vm setup              Initial VM setup
#   ./bin/vm test               Run integration tests in VM
#   ./bin/vm simulate <scenario> Run a simulation scenario
#

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
VM_DIR="${PROJECT_ROOT}/.pi-vm"

case "${1:-help}" in
    start)
        if [ "${2:-}" == "--fast" ]; then
            exec "${VM_DIR}/start-pi-fast.sh"
        else
            exec "${VM_DIR}/start-pi.sh"
        fi
        ;;
    ssh)
        exec ssh -p 9522 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null pi@localhost
        ;;
    setup)
        exec "${PROJECT_ROOT}/scripts/vm/setup-pi-vm.sh"
        ;;
    test)
        echo "Running integration tests in VM..."
        ssh -p 9522 -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null pi@localhost "cd ~/nightwatch && pytest tests/integration/ -v"
        ;;
    simulate)
        scenario="${2:-normal}"
        echo "Running simulation: $scenario"
        python3 "${PROJECT_ROOT}/scripts/vm/radar-simulator.py" --scenario "$scenario"
        ;;
    help|--help|-h|*)
        echo "Nightwatch VM Management"
        echo ""
        echo "Usage: ./bin/vm <command> [options]"
        echo ""
        echo "Commands:"
        echo "  start [--fast]        Start the Pi VM"
        echo "  ssh                   SSH into running VM"
        echo "  setup                 Initial VM setup (download image, etc)"
        echo "  test                  Run integration tests in VM"
        echo "  simulate <scenario>   Run a simulation (normal, apnea, seizure)"
        echo ""
        echo "Examples:"
        echo "  ./bin/vm setup        # First-time setup"
        echo "  ./bin/vm start        # Start with accurate Pi emulation"
        echo "  ./bin/vm start --fast # Start with fast emulation"
        echo "  ./bin/vm ssh          # Connect to running VM"
        ;;
esac
